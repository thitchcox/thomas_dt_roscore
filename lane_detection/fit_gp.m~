% Fit a GP to detected lane points.  
% Assume that points have been detected and passed thru ground projection
% node.  Also, we know which points are white and which are yellow.  

% TODO
% - Result seems to be sensitive to the kernelScale parameter.  Once I
% train this hyperparameter, how to I use it in a function?

close all
clc
config_lane_gp;

% Choose a data file to process
% load('aligned_straight.mat')
% load('offset_straight.mat')
% load('aligned_curve_right.mat')
% load('offset_curve_right.mat')
% load('aligned_curve_left.mat')
% load('offset_curve_left.mat')

% Choose whether to optimize gp hyperparameters
tf_optimize_hyperparameters = false;


%% Fit GPs
if tf_optimize_hyperparameters
    disp('Optimizing GP hyperparamters...')
    tic
    % Fit a GP to white points: x = f(y)
    gpWhite = fitrgp(y_white, x_white, 'BasisFunction', 'constant', 'Beta', ...
        lane_width / 2, 'KernelFunction', 'matern32', 'OptimizeHyperparameters', ...
        'kernelscale');

    % Fit a GP to yellow points: x = f(y)
    gpYellow = fitrgp(y_yellow, x_yellow, 'BasisFunction', 'constant', 'Beta', ...
        -lane_width / 2, 'KernelFunction', 'matern32', 'OptimizeHyperparameters', ...
        'kernelscale');
    disp('Done.')
    toc
else
    disp('Fitting GPs...')
    tic
    gpWhite = fitrgp(y_white, x_white);
    gpYellow = fitrgp(y_yellow, x_yellow);
    disp('Done.')
    toc
end


%% Predict
% Use gpWhite to predict white line on a regular spacing
lin_x_white = gpWhite.predict(lin_y.');

% Use gpYellow tp predict yellow line on a regular spacing
lin_x_yellow = gpYellow.predict(lin_y.');

% Generate mean path estimate as the average of the two GPs.
x_mid = mean([lin_x_yellow, lin_x_white], 2);


%% Generate pose estimate
% Fit a line to the mean path estimate close to the robot
close_pts = lin_y <= fit_line_to_nearest;
y_nearest = lin_y(close_pts);
x_nearest = x_mid(close_pts);

% Fit a line to these points
line = polyfit(x_nearest , y,1);


%% Plots
figure
ha = gca;
hold on

% Show the points
scatter(ha, x_white, y_white, 'MarkerEdgeColor', 'k', 'MarkerFaceColor', 'w')
scatter(ha, x_yellow, y_yellow, 'MarkerEdgeColor', 'k', 'MarkerFaceColor', matlab_yellow)

% Show the GPs
plot(ha, lin_x_white, lin_y, '-', 'LineWidth', line_width, 'Color', matlab_grey)
plot(ha, lin_x_yellow, lin_y, '-', 'LineWidth', line_width, 'Color', matlab_yellow);
plot(ha, x_mid, lin_y, '--', 'LineWidth', line_width, 'Color', matlab_cyan)

% Set limits and grid.
ha.XLim = x_lim_sandbox;
ha.YLim = y_lim_sandbox;
xline(0, '--');
grid on

% Label the plot
hp = get(gca, 'Children');
legend([hp(6), hp(5), hp(4) hp(3), hp(2)], 'Detected white point', ...
    'Detected yellow point', 'White line estimate', 'Yellow line estimate', ...
    'Trajectory estimate')
xlabel('X [m]')
ylabel('Y [m]')

